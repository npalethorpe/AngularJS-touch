app.directive('fTouch',['$window','$timeout',function($window,$timeout){return{restrict:'A',scope:{stopPropagation:'=?stoppropagation',triggeredTaps:'=?triggeredtaps',onTouchstart:'&fTouchstart',onShortpress:'&fShortpress',onLongpress:'&fLongpress',onTap:'&fTap',onLongtap:'&fLongtap',onMove:'&fMove',onPinch:'&fPinch',onSwipeleft:'&fSwipeleft',onSwiperight:'&fSwiperight',onSlidingx:'&fSlidingx',onSlidingy:'&fSlidingy',onTouchendnodrag:'&fTouchendnodrag',onTouchend:'&fTouchend',onTriggeredTap:'&fTriggeredtap'},link:function($scope,$elm,$attr){var LOG_TAG='TOUCH_DIR: ';var $startX=0;var $startY=0;var $startTime;var $shortPressInterval;var $longPressInterval;var $distance=0;var $allowedDistance=$window.innerWidth*0.05;var $hasDragged=!1;var $hasEnded=!1;var $isPinching=!1;var $pinchStartDist=0;var $pinchLastDist=0;var $touchstart_key=('ontouchstart' in window?'touchstart':window.navigator.pointerEnabled?'pointerdown':window.navigator.msPointerEnabled?'MSPointerDown':'click');var $touchend_key=('ontouchend' in window?'touchend':window.navigator.pointerEnabled?'pointerup':window.navigator.msPointerEnabled?'MSPointerUp':'');var $touchmove_key=('ontouchmove' in window?'touchmove':window.navigator.pointerEnabled?'pointermove':window.navigator.msPointerEnabled?'MSPointerMove':'');var $isCancelled=!1;var $shortTimeQualifier=500;var $longTimeQualifier=2000;var $swipeDistQualifier=$window.innerWidth*0.2;var $swipeTimeQualifier=300;var $slideDirection=-1;var $tapCount=0;var $lastTapTicks=0;var clearClickEvents=function(Obj){console.log(LOG_TAG+'Clearing all attached events');Obj.off();Obj.unbind()};var cancelTimeouts=function(){$timeout.cancel($shortPressInterval);$timeout.cancel($longPressInterval)};clearClickEvents($elm);$elm.bind($touchstart_key,function(e){console.log(LOG_TAG+'Touch Start');$hasDragged=!1;$isCancelled=!1;$hasEnded=!1;cancelTimeouts();$startTime=new Date().getTime();console.log(LOG_TAG+'Adding fTouchdown class');$elm.addClass("ftouchdown");$timeout(function(){if(!$hasDragged){$shortPressInterval=$timeout(function(){if(!$isCancelled&&!$hasDragged&&!$hasEnded){$scope.onShortpress({e:e})}},$shortTimeQualifier);$longPressInterval=$timeout(function(){if(!$isCancelled&&!$hasDragged&&!$hasEnded){$scope.onLongpress({e:e})}},$longTimeQualifier);$scope.onTouchstart({e:e})}
if(e.touches.length==2){console.log(LOG_TAG+'Registered Pinch Start');$isPinching=!0;cancelTimeouts();$pinchStartDist=Math.sqrt((e.touches[0].pageX-e.touches[1].pageX)*(e.touches[0].pageX-e.touches[1].pageX)+(e.touches[0].pageY-e.touches[1].pageY)*(e.touches[0].pageY-e.touches[1].pageY))}},80);$startX=e.pageX||e.originalEvent.pageX||e.originalEvent.targetTouches[0].pageX;$startY=e.pageY||e.originalEvent.pageY||e.originalEvent.targetTouches[0].pageY;if($startX===undefined||$startY===undefined){$startX=-1;$startY=-1;console.log(LOG_TAG+'Touch End (Invalid Start Event)');$scope.onTouchend({e:e})}
if($scope.stopPropagation){console.log(LOG_TAG+'Stopping Propagation');e.stopPropagation();e.preventDefault()}});$elm.bind($touchmove_key,function(e){$scope.onMove({e:e});var dx=-1;var dy=-1;if($isPinching){dx=e.touches[0].pageX-e.touches[1].pageX;dy=e.touches[0].pageY-e.touches[1].pageY;$pinchLastDist=Math.sqrt((dx*dx)+(dy*dy));console.log(LOG_TAG+'Pinched: '+($pinchLastDist-$pinchStartDist));$scope.onPinch({e:($pinchLastDist-$pinchStartDist)})}else{dx=$startX-e.touches[0].pageX;dy=$startY-e.touches[0].pageY;$distance=Math.sqrt((dx*dx)+(dy*dy));if($distance>$allowedDistance){if($hasDragged===!1){$hasDragged=!0;$elm.removeClass("ftouchdown")}
if($slideDirection==-1){if(Math.abs(dx)>Math.abs(dy)){$slideDirection=dx<0?1:3}else{$slideDirection=dy<0?2:0}}
if($slideDirection===0||$slideDirection==2){$slideDirection=dy<0?2:0;$scope.onSlidingy({e:dy})}else if($slideDirection==1||$slideDirection==3){$slideDirection=dx<0?1:3;$scope.onSlidingx({e:dx})}}}});$elm.bind($touchend_key,function(e){console.log(LOG_TAG+'Function Touch End');var $endTime=new Date().getTime();if(e.touches.length>0){console.log(LOG_TAG+'Finished Pinch but still have an active touch');$isPinching=!1;return}
$hasEnded=!0;cancelTimeouts();if($hasDragged===!1&&$isCancelled===!1){if($endTime-$startTime<$shortTimeQualifier){$scope.onTap({e:e});if($scope.triggeredTaps!==undefined){if($lastTapTicks===undefined||(new Date().getTime()-$lastTapTicks)>800){console.log(LOG_TAG+'Clearing down the Tap Count');$tapCount=0}
$tapCount++;$lastTapTicks=new Date().getTime();if($tapCount>=$scope.triggeredTaps){$tapCount=0;$scope.onTriggeredTap({e:e})}}}else if($endTime-$startTime<$longTimeQualifier){$scope.onLongtap({e:e})}
$scope.onTouchendnodrag({e:e})}else if($hasDragged&&($endTime-$startTime)<=$swipeTimeQualifier){if($distance>=$swipeDistQualifier){if($slideDirection==1){$scope.onSwiperight({e:e})}else if($slideDirection==3){$scope.onSwipeleft({e:e})}}}
$slideDirection=-1;$elm.removeClass("ftouchdown");$scope.onTouchend({e:e});if($scope.stopPropagation){console.log(LOG_TAG+'Stopping Propagation');e.stopPropagation();e.preventDefault()}});$elm.bind('click',function(e){e.preventDefault()})}}}])
